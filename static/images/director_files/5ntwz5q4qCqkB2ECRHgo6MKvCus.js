window.jQuery&&window.jQuery.fn.bem&&window.bemhtml&&(BEM.DOM.decl("cbir-page-layout",{scrollYPrev:0,onSetMod:{js:{inited:function(){this._onScrollTrottled=$.throttle(this._onScroll,100,this)}}},_onScroll:function(){!window.scrollY||window.scrollY>this.scrollYPrev?this.delMod("navigation"):window.scrollY<this.scrollYPrev&&this.setMod("navigation","visible"),this.scrollYPrev=window.scrollY},_onLoadingStart:function(e){this.setMod("loading",e.pageFragmentName),this.delMod("failure"),"main-content"===e.pageFragmentName&&Ya.reactBus.emit("react-adapter:unmount",this.findElem("main-content").get(0)),window.scrollTo(window.scrollX,0)},_onCbirUpdateUrl:function(e){this.params.cbirId=e.cbirId,this.params.originalImageUrl=e.originalImageUrl,this.params.cropRect=e.cropRect,this.params.cropId=e.cropId},_onLoadingSuccess:function(e){var t=BEM.blocks["serp-controller"].getInstance();t._onPageContentUpdated(),t._onPageTypeChanged(e.pageType),this.delMod("loading")},_onLoadingFailure:function(e){this.delMod("loading"),this.setMod("failure",e.pageFragmentName)},_onImagesViewerOpen:function(){var e=window.innerWidth-document.documentElement.clientWidth;this.domElem.css("margin-right",e+"px")},_onImagesViewerClosed:function(){this.domElem.css("margin-right","")},_updateGlobalParams:function(e){BEM.blocks["b-page"].getInstance().updateGlobalParams(e)},_updateSerpParams:function(e){BEM.blocks["b-page"].getInstance().updateSerpParams(e)},_updateContent:function(e,t){var a=this.findElem(e);Ya.reactBus.emit("react-adapter:unmount",a.get(0)),BEM.DOM.replace(a,t.html),a=this.findElem(e),Ya.reactBus.emit("react-adapter:mount",a.get(0))},_abortCurrentRequest:function(){this._currentRequest&&(this._currentRequest.abort(),this._currentRequest=void 0)},_checkImageIsSame:function(e){var t=BEM.blocks.uri.getFlatParams(e),a=t.cbir_id,i=t.url,r=this.params.cbirId,n=this.params.originalImageUrl;return this.params.cbirId=a,this.params.originalImageUrl=i,Boolean(a&&r===a||i&&n===i)},_checkCropIsSame:function(e){var t=BEM.blocks.uri.getFlatParams(e),a=t.crop,i=void 0!==t.crop_id?Number(t.crop_id):void 0,r=this.params.cropRect,n=this.params.cropId;return this.params.cropRect=a,this.params.cropId=i,r===a&&n===i},_getUpdatedPageFragmentName:function(e){var t=e.url;return this._checkImageIsSame(t)?this._checkCropIsSame(t)?"main-content":"body":"full"},load:function(e){this._abortCurrentRequest();var t=this._getUpdatedPageFragmentName(e);switch(t){case"full":BEM.blocks["cbir-controller"].getInstance().loadFullPage(e);break;case"main-content":case"body":var a=e.pageType,i=e.url;Ya.reactBus.emit("cbir:page-loading-start",{pageType:a,pageFragmentName:t});var r=BEM.create("i-request_type_bem",{url:i,ctx:this,cache:!1});r.block("i-global__params:ajax",this._updateGlobalParams),r.block("serp-controller",this._updateSerpParams);var n=this,o="cbir-page-layout__"+t+":ajax";r.block(o,function(e){n._currentRequest=void 0,n._updateContent(t,e),Ya.reactBus.emit("cbir:page-loading-success",{pageType:a,pageFragmentName:t})},function(){n._currentRequest=void 0,Ya.reactBus.emit("cbir:page-loading-failure",{pageType:a,pageFragmentName:t})},{pageType:a}),r.on("beforeCallback",function(){BEM.blocks["b-page"].getInstance().setMod("type",a)}),this._currentRequest=r.get()}}},{live:function(){this.__base.apply(this,arguments),this.liveInitOnReactBusEvent("cbir:page-loading-start",function(e){this._onLoadingStart(e)}).liveInitOnReactBusEvent("cbir:page-loading-success",function(e){this._onLoadingSuccess(e)}).liveInitOnReactBusEvent("cbir:page-loading-failure",function(e){this._onLoadingFailure(e)}).liveInitOnReactBusEvent("cbir:update-url",function(e){this._onCbirUpdateUrl(e)}).liveInitOnReactBusEvent("images-viewer:open",function(){this._onImagesViewerOpen()}).liveInitOnReactBusEvent("images-viewer:closed",function(){this._onImagesViewerClosed()}).liveBindToWin("scroll",function(){this._onScrollTrottled()})}}),BEM.DOM.decl("cbir-update-url",{onSetMod:{js:{inited:function(){this.__base.apply(this,arguments),this._updateUrlParams(this.params.originalImageUrl,this.params.cbirId,this.params.cropRect,this.params.cropId)}}},_updateUrlParams:function(e,t,a,i){var r=BEM.blocks.uri.getFlatParams(),n=r.url,o=r.cbir_id,s=r.crop,c=r.crop_id;if(n!==e||o!==t||s!==a||c!==i){var l=BEM.blocks.location.getInstance(),u=BEM.blocks.uri.setParams({url:e,cbir_id:t,crop:a,crop_id:i});Ya.reactBus.emit("cbir:update-url",{originalImageUrl:e,cbirId:t,cropRect:a,cropId:i}),l.change(Object.assign({},history.state,{block:l.getState().block,url:u,trigger:!1,history:!1})),BEM.blocks["b-page"].getInstance().updateCacheKey()}}}));