window.jQuery&&window.jQuery.fn.bem&&window.bemhtml&&(BEM.DOM.decl({block:"cbir-similar-page"},{_onLoadingStart:function(e){BEM.blocks["b-page"].getInstance().showFade(),this.setMod("loading"),this.delMod("failure")},_onLoadingSuccess:function(e){var a=BEM.blocks["serp-controller"].getInstance();a._onPageContentUpdated(),a._onPageTypeChanged(e.pageType),BEM.blocks["b-page"].getInstance().hideFade(),this.delMod("loading")},_onLoadingFailure:function(e){BEM.blocks["b-page"].getInstance().hideFade(),this.delMod("loading"),this.setMod("failure")},_updateMainContentBlock:function(e){var a=this.findElem("content");0!==a.length&&(Ya.reactBus.emit("react-adapter:unmount",a.get(0)),BEM.DOM.replace(a,e.html),a=this.findElem("content"),Ya.reactBus.emit("react-adapter:mount",a.get(0)),Ya.reactBus.emit("cbir:update-similar-filters",e.params))},_abortCurrentRequest:function(){this._currentRequest&&(this._currentRequest.abort(),this._currentRequest=void 0)},_checkImageIsSame:function(e){var a=BEM.blocks.uri.getFlatParams(e),t=a.cbir_id,i=a.url,r=this.params.cbirId,n=this.params.originalImageUrl;return this.params.cbirId=t,this.params.originalImageUrl=i,Boolean(t&&r===t||i&&n===i)},_getUpdatedPageFragmentName:function(e){var a=e.pageType,t=e.url;return"similar"===a&&this._checkImageIsSame(t)?"main-content":"full"},load:function(e){var a=this._getUpdatedPageFragmentName(e);switch(this._abortCurrentRequest(),a){case"full":BEM.blocks["cbir-controller"].getInstance().loadFullPage(e);break;case"main-content":var t=e.pageType,i=e.url;Ya.reactBus.emit("cbir:similar-page-loading-start",{pageType:t,pageFragmentName:a});var r=BEM.create("i-request_type_bem",{url:i,passedParams:[],ctx:this,cache:!1});r.block("i-global__params:ajax",function(e){BEM.blocks["b-page"].getInstance().updateGlobalParams(e)}),r.block("search2:ajax",function(e){BEM.blocks["b-page"].getInstance().trigger("search:input:update",e)}),r.block("serp-controller",function(e){BEM.blocks["b-page"].getInstance().updateSerpParams(e)}),r.block("cbir-similar-page__content:ajax",this._updateMainContentBlock.bind(this)),r.on("beforeCallback",function(){BEM.blocks["b-page"].getInstance().setMod("type",t)});var n=this;this._currentRequest=r.get(function(){n._currentRequest=void 0,Ya.reactBus.emit("cbir:similar-page-loading-success",{pageType:t,pageFragmentName:a})},function(){n._currentRequest=void 0,Ya.reactBus.emit("cbir:similar-page-loading-failure",{pageType:t,pageFragmentName:a})})}}},{live:function(){this.__base.apply(this,arguments),this.liveInitOnReactBusEvent("cbir:similar-page-loading-start",function(e){this._onLoadingStart(e)}).liveInitOnReactBusEvent("cbir:similar-page-loading-success",function(e){this._onLoadingSuccess(e)}).liveInitOnReactBusEvent("cbir:similar-page-loading-failure",function(e){this._onLoadingFailure(e)})}}),BEM.DOM.decl("cbir-update-url",{onSetMod:{js:{inited:function(){this.__base.apply(this,arguments),this._updateUrlParams(this.params.originalImageUrl,this.params.cbirId,this.params.cropRect,this.params.cropId)}}},_updateUrlParams:function(e,a,t,i){var r=BEM.blocks.uri.getFlatParams(),n=r.url,s=r.cbir_id,c=r.crop,o=r.crop_id;if(n!==e||s!==a||c!==t||o!==i){var l=BEM.blocks.location.getInstance(),u=BEM.blocks.uri.setParams({url:e,cbir_id:a,crop:t,crop_id:i});Ya.reactBus.emit("cbir:update-url",{originalImageUrl:e,cbirId:a,cropRect:t,cropId:i}),l.change(Object.assign({},history.state,{block:l.getState().block,url:u,trigger:!1,history:!1})),BEM.blocks["b-page"].getInstance().updateCacheKey()}}}));